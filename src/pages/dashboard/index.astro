---
export const prerender = false;
import BaseLayout from "../../layouts/BaseLayout.astro";


// Components
import ProgressBar from "../../components/ProgressBar.astro";
import History from '../../components/History.astro';
import Footer from "../../components/Footer.astro";

import { supabase } from "../../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin");
}

const email = session.data.user?.email;
---
<BaseLayout title="Panel de Control">
    <header class="flex font-daruma h-50 bg-pink justify-center items-center">
        <p class="text-center text-pr-purple text-[60px] tracking-wider">MEOWNY</p>
    </header>
    <ProgressBar start="1,810" goal="85,240" current="44,260"/>
    <History />

    <Footer />
</BaseLayout>